{"questionTitle": "System.ServiceModel.CommunicationException: The underlying connection was closed", "question": "<p>I am retrieving data from a wcf web service and when data is more than 0.2 million records i get an exception which is as under:</p>\n<pre><code>System.ServiceModel.CommunicationException: The underlying connection was closed: A connection that was expected to be kept alive was closed by the server. ---&gt; System.Net.WebException: The underlying connection was closed: A connection that was expected to be kept alive was closed by the server. ---&gt; System.IO.IOException: Unable to read data from the transport connection: An existing connection was forcibly closed by the remote host. ---&gt; System.Net.Sockets.SocketException: An existing connection was forcibly closed by the remote host\nat System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset, Int32 size, SocketFlags socketFlags)\nat System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset, Int32 size)\n--- End of inner exception stack trace ---\nat System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset, Int32 size)\nat System.Net.PooledStream.Read(Byte[] buffer, Int32 offset, Int32 size)\nat System.Net.Connection.SyncRead(HttpWebRequest request, Boolean userRetrievedStream, Boolean probeRead)\n--- End of inner exception stack trace ---\nat System.Net.HttpWebRequest.GetResponse()\nat System.ServiceModel.Channels.HttpChannelFactory`1.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout)\n--- End of inner exception stack trace ---\n\nServer stack trace: \nat System.ServiceModel.Channels.HttpChannelUtilities.ProcessGetResponseWebException(WebException webException, HttpWebRequest request, HttpAbortReason abortReason)\nat System.ServiceModel.Channels.HttpChannelFactory`1.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout)\nat System.ServiceModel.Channels.RequestChannel.Request(Message message, TimeSpan timeout)\nat System.ServiceModel.Dispatcher.RequestChannelBinder.Request(Message message, TimeSpan timeout)\nat System.ServiceModel.Channels.ServiceChannel.Call(String action, Boolean oneway, ProxyOperationRuntime operation, Object[] ins, Object[] outs, TimeSpan timeout)\nat System.ServiceModel.Channels.ServiceChannelProxy.InvokeService(IMethodCallMessage methodCall, ProxyOperationRuntime operation)\nat System.ServiceModel.Channels.ServiceChannelProxy.Invoke(IMessage message)\n</code></pre>\n<p>My web.config looks like this :</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;basicHttpBinding&gt;\n  &lt;binding name=&quot;BasicHttpBinding_IService&quot; closeTimeout=&quot;00:01:00&quot; openTimeout=&quot;00:01:00&quot; receiveTimeout=&quot;00:10:00&quot; sendTimeout=&quot;00:01:00&quot;\n             maxBufferSize=&quot;2147483647&quot; maxBufferPoolSize=&quot;2147483647&quot; maxReceivedMessageSize=&quot;2147483647&quot;\n             allowCookies=&quot;false&quot; bypassProxyOnLocal=&quot;false&quot; hostNameComparisonMode=&quot;StrongWildcard&quot;\n             messageEncoding=&quot;Text&quot; textEncoding=&quot;utf-8&quot; transferMode=&quot;StreamedResponse&quot; useDefaultWebProxy=&quot;true&quot;&gt;\n    &lt;readerQuotas maxDepth=&quot;32&quot; maxStringContentLength=&quot;2147483647&quot; maxArrayLength=&quot;2147483647&quot;\n                  maxBytesPerRead=&quot;2147483647&quot; maxNameTableCharCount=&quot;2147483647&quot; /&gt;\n    &lt;security mode=&quot;None&quot;&gt;\n      &lt;transport clientCredentialType=&quot;None&quot; proxyCredentialType=&quot;None&quot; realm=&quot;&quot; /&gt;\n      &lt;message clientCredentialType=&quot;UserName&quot; algorithmSuite=&quot;Default&quot; /&gt;\n    &lt;/security&gt;\n  &lt;/binding&gt;\n  &lt;binding maxReceivedMessageSize=&quot;2147483647&quot; allowCookies=&quot;true&quot;&gt;\n    &lt;readerQuotas maxDepth=&quot;32&quot; maxStringContentLength=&quot;2147483647&quot; maxArrayLength=&quot;2147483647&quot; maxBytesPerRead=&quot;2147483647&quot;\nmaxNameTableCharCount=&quot;2147483647&quot; /&gt;\n  &lt;/binding&gt;\n&lt;/basicHttpBinding&gt;\n</code></pre>\n<p>I am sure that my web service is retrieving data from DB. but is unable to transfer to my web from where i initiated the call. Thanks in advance for any help.</p>\n", "acceptedAnswer": "<p>I had recently the same problem with a Wcf service within a .Net 4.0 web app. I increased the maxItemsInObjectGraph value and server didn't throw the exception anymore. The documentation <a href=\"http://msdn.microsoft.com/en-us/library/system.runtime.serialization.datacontractserializer.maxitemsinobjectgraph%28v=vs.100%29.aspx\" rel=\"nofollow noreferrer\">here</a> says the default maximum is Int32.MaxValue but I think it is incorrect, the maximum value is 65535.</p>\n<pre class=\"lang-xml prettyprint-override\"><code>   &lt;serviceBehaviors&gt;\n    &lt;behavior name=&quot;ServiceBehaviour&quot;&gt;\n      &lt;dataContractSerializer maxItemsInObjectGraph=&quot;6553500&quot;/&gt;\n      &lt;serviceMetadata httpGetEnabled=&quot;true&quot; /&gt;\n      &lt;serviceDebug includeExceptionDetailInFaults=&quot;true&quot; /&gt;\n    &lt;/behavior&gt;\n  &lt;/serviceBehaviors&gt;\n</code></pre>\n<p>The other thing you can do is enable tracing. This is an example of what I have in the web.config:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;system.diagnostics&gt;\n  &lt;sources&gt;\n    &lt;source name=&quot;System.ServiceModel&quot;\n            switchValue=&quot;Information, ActivityTracing&quot;\n            propagateActivity=&quot;true&quot;&gt;\n      &lt;listeners&gt;\n        &lt;add name=&quot;traceListener&quot;\n            type=&quot;System.Diagnostics.XmlWriterTraceListener&quot;\n            initializeData= &quot;c:\\temp\\log\\Traces.svclog&quot; /&gt;\n      &lt;/listeners&gt;\n    &lt;/source&gt;\n  &lt;/sources&gt;\n&lt;/system.diagnostics&gt;\n</code></pre>\n<p>If you double click on the Traces.svclog, windows should open the Microsoft Service Trace Viewer.</p>\n<p>If you test your service with the Microsoft WCF Test Client make sure you change the default client config to match the server settings (this includes the client endpoint behavior) to make sure the client can receive the response from the server.</p>\n", "questionSource": "https://stackoverflow.com/questions/19518978/system-servicemodel-communicationexception-the-underlying-connection-was-closed"}