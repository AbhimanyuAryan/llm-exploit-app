{"questionTitle": "Append Filename to File in Azure Storage", "question": "<p>I am a bit stuck in a simple problem but I seem to have lost grey matter and keep looping (which is exactly a problem here). I am trying to upload the files from local to azure storage and then append the file name to the file in the cloud so later I can add and check if I have already processed such file.</p>\n<p>Here is my code:</p>\n<pre><code>import os\nfrom azure.identity import DefaultAzureCredential\nfrom azure.storage.filedatalake import DataLakeServiceClient,DataLakeFileClient\n\n\n\n\n\n    # Iterate over files in the local directory\n    for filename in os.listdir(local_path):\n        if os.path.isfile(os.path.join(local_path, filename)):\n            # Get a reference to the file client\n            file_client = directory_client.get_file_client(filename)\n\n            # Upload the file to Azure Data Lake Storage\n            with open(os.path.join(local_path, filename), &quot;rb&quot;) as local_file:\n                file_client.upload_data(local_file, overwrite=True)\n\n            if not checkpoint_directory_client.create_file(file=checkpoint_file_name):\n                checkpoint_directory_client.create_file(file=checkpoint_file_name)\n                checkpoint_file_client = checkpoint_directory_client.get_file_client(checkpoint_file_name)\n                \n             *&lt;&lt;&lt;I think I need something here but I tried everything and I cannot seem to do it&gt;&gt;&gt;&gt;*\n</code></pre>\n<p>I tried with DataLakeFileClient as well but to no avail. I either can upload one name to the file (last one which is indicative of the position inside a loop)or get empty file. I just need a little push in the right direction!</p>\n<p>I am trying something like this</p>\n<pre><code>checkpoint_directory_client.create_file(file=checkpoint_file_name)\ncheckpoint_file_client = checkpoint_directory_client.get_file_client(checkpoint_file_name)\ndata = filename\ncheckpoint_file_client.append_data(data,offset=0,length=len(data))\ncheckpoint_file_client.flush_data(len(data))\n</code></pre>\n<p>Thanks a bunch</p>\n", "acceptedAnswer": "<blockquote>\n<p>Append Filename to File in Azure Storage</p>\n</blockquote>\n<p>You can use the code below to append the filename to the file after creating the checkpoint file, using the <code>append_data</code> method of the <code>DataLakeFileClient</code> object.</p>\n<p>Here is the full code:</p>\n<p><strong>Code:</strong></p>\n<pre><code>import os\nfrom azure.identity import DefaultAzureCredential\nfrom azure.storage.filedatalake import DataLakeServiceClient, DataLakeFileClient\n\ntry:\n    account_url = &quot;https://xxxx.dfs.core.windows.net/&quot;\n    default_credential = DefaultAzureCredential()\n    service_client = DataLakeServiceClient(account_url, credential=default_credential)\n    container_name = &quot;test&quot;\n    directory_name = &quot;sample&quot;\n    filesystem_name = container_name\n    directory_name = directory_name\n    checkpoint_directory_name = &quot;checkpoint&quot;\n    checkpoint_file_name = &quot;checkpointfile.txt&quot;\n\n    local_path = r&quot;C:\\Users\\xxxx\\Documents\\venkat1&quot;\n    if not os.path.exists(local_path):\n        os.mkdir(local_path)\n    directory_client = service_client.get_file_system_client(filesystem_name).get_directory_client(directory_name)\n    checkpoint_directory_client = service_client.get_directory_client(file_system=filesystem_name, directory=f&quot;{directory_name}/{checkpoint_directory_name}&quot;)\n    checkpoint_file_client = checkpoint_directory_client.get_file_client(checkpoint_file_name)\n    checkpoint_file_service = DataLakeFileClient(account_url=account_url, credential=default_credential, file_system_name=filesystem_name, file_path=checkpoint_file_client.path_name)\n\n    # Iterate over files in the local directory\n    for filename in os.listdir(local_path):\n        if os.path.isfile(os.path.join(local_path, filename)):\n            file_client = directory_client.get_file_client(filename)\n            with open(os.path.join(local_path, filename), &quot;rb&quot;) as local_file:\n                file_client.upload_data(local_file, overwrite=True)\n\n            checkpoint_directory_client.create_file(file=checkpoint_file_name)\n            checkpoint_file_client = checkpoint_directory_client.get_file_client(checkpoint_file_name)\n            data = filename.encode('utf-8')\n            checkpoint_file_client.append_data(data, offset=0, length=len(data))\n            checkpoint_file_client.flush_data(len(data))\n\n    print(&quot;All files uploaded successfully.&quot;)\n\nexcept Exception as ex:\n    print('Exception:')\n    print(ex)\n</code></pre>\n<p>The above code uploads files from a local directory to Azure Data Lake Storage and creates a <strong><code>checkpoint file</code></strong> to keep track of the uploaded files. For each file, it appends the filename to the checkpoint file using the <strong><code>append_data</code></strong> method of the DataLakeFileClient object.</p>\n<p><strong>Output:</strong></p>\n<pre><code>All files uploaded successfully.\n</code></pre>\n<p><img src=\"https://i.imgur.com/YWYCiyi.png\" alt=\"enter image description here\" /></p>\n<p><strong>Portal:</strong></p>\n<p><img src=\"https://i.imgur.com/HJtBrWl.png\" alt=\"enter image description here\" /></p>\n<p><strong>Reference:</strong></p>\n<p><a href=\"https://learn.microsoft.com/en-us/azure/storage/blobs/data-lake-storage-directory-file-acl-python?tabs=azure-ad#append-data-to-a-file\" rel=\"nofollow noreferrer\">Use Python to manage data in Azure Data Lake Storage Gen2 - Azure Storage | Microsoft Learn</a></p>\n<p><strong>Update:</strong></p>\n<p>To write the all files into the (checkpoint)file you can modify code as like below:</p>\n<p><strong><code>Code:</code></strong></p>\n<pre><code>for filename in os.listdir(local_path):\n        if os.path.isfile(os.path.join(local_path, filename)):\n            file_name, file_extension = os.path.splitext(filename)\n            new_filename = f&quot;{file_name}.{file_extension[1:]}&quot; \n            file_client = directory_client.get_file_client(filename)\n            with open(os.path.join(local_path, filename), &quot;rb&quot;) as local_file:\n                file_client.upload_data(local_file, overwrite=True)\n\n            data = f&quot;{new_filename}\\n&quot;.encode('utf-8')\n            offset = checkpoint_file_client_new.get_file_properties().size\n            checkpoint_file_client_new.append_data(data, offset=offset, length=len(data))\n            checkpoint_file_client_new.flush_data(offset + len(data))\n</code></pre>\n<p><strong>Output:</strong></p>\n<p><a href=\"https://i.stack.imgur.com/kJadl.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/kJadl.png\" alt=\"enter image description here\" /></a></p>\n", "questionSource": "https://stackoverflow.com/questions/78261705/append-filename-to-file-in-azure-storage"}