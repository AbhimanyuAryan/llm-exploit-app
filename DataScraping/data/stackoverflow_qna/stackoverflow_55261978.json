{"questionTitle": "How to calculate mean average precision (mAP) using TensorFlow?", "question": "<p>I want to use TensorFlow to calculate hashcode\u2018s mAP \uff08mean average precision\uff09\uff0c but I don\u2018t know how to use tensor calculations directly.</p>\n\n<h2>The code which using NumPy is the following:</h2>\n\n<pre><code>import numpy as np\nimport time\nimport os\n# read train and test binarayCode\nCURRENT_DIR = os.getcwd()\n\n\n\ndef getCode(train_codes,train_groudTruth,test_codes,test_groudTruth):\n\n    line_number = 0\n    with open(CURRENT_DIR+'/result.txt','r') as f:\n        for line in f:\n            temp = line.strip().split('\\t')\n            if line_number &lt; 10000:\n                test_codes.append([i if i==1 else -1  for i in map(int, list(temp[0]))])\n                list2 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n                list2[int(temp[1])] = 1\n                test_groudTruth.append(list2) # get test ground truth(0-9)\n            else:\n                train_codes.append([i if i==1 else -1  for i in map(int, list(temp[0]))]) # change to -1, 1\n                list2 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n                list2[int(temp[1])] = 1\n                train_groudTruth.append(list2) # get test ground truth(0-9)\n\n            line_number += 1\n    print 'read data finish'\n\ndef getHammingDist(code_a,code_b):\n    dist = 0\n    for i in range(len(code_a)):\n         if code_a[i]!=code_b[i]:\n             dist += 1\n    return dist \n\n\nif __name__ =='__main__':\n    print getNowTime(),'start!'\n\n    train_codes = []\n    train_groudTruth =[]\n\n    test_codes = []\n    test_groudTruth = []\n    # get g.t. and binary code\n    getCode(train_codes,train_groudTruth,test_codes,test_groudTruth)\n    train_codes = np.array(train_codes)\n    train_groudTruth = np.array(train_groudTruth)\n    test_codes = np.array(test_codes)\n    test_groudTruth = np.array(test_groudTruth)\n    numOfTest = 10000\n\n    # generate hanmming martix, g.t. martix  10000*50000\n    gt_martix = np.dot(test_groudTruth, np.transpose(train_groudTruth))\n    print getNowTime(),'gt_martix finish!'\n    ham_martix = np.dot(test_codes, np.transpose(train_codes)) # hanmming distance map to dot value \n    print 'ham_martix finish!'\n\n    # sort hanmming martix,Returns the indices that would sort an array.\n    sorted_ham_martix_index = np.argsort(ham_martix,axis=1)\n\n    # calculate mAP\n    print 'sort ham_matrix finished,start calculate mAP'\n\n    apall = np.zeros((numOfTest,1),np.float64)\n    for i in range(numOfTest):\n        x = 0.0\n        p = 0\n        test_oneLine = sorted_ham_martix_index[i,:]\n        length = test_oneLine.shape[0]\n        num_return_NN = 5000 # top 1000\n        for j in range(num_return_NN):\n             if gt_martix[i][test_oneLine[length-j-1]] == 1: # reverse\n                 x += 1\n                 p += x/(j+1)\n        if p == 0:\n            apall[i]=0\n        else:\n            apall[i]=p/x\n\n    mAP = np.mean(apall)\n    print 'mAP:',mAP\n</code></pre>\n\n<hr>\n\n<p>I want to re-write the code above using tensor operations (like <code>tf.equal()</code>\u3001<code>tf.reduce_sum()</code> so on).</p>\n\n<p>for example</p>\n\n<h2>I want to calculate valid accuracy of images</h2>\n\n<pre><code>logits = self._model(x_valid)\nvalid_preds = tf.argmax(logits, axis=1)\nvalid_preds = tf.to_int32(valid_preds)\nself.valid_acc = tf.equal(valid_preds, y_valid)\nself.valid_acc = tf.to_int32(self.valid_acc)\nself.valid_acc = tf.to_float(tf.reduce_sum(self.valid_acc))/tf.to_float(self.batch_size)\n</code></pre>\n\n<hr>\n\n<p>I want to use TensorFlow to calculate hashcode\u2018s mAP \uff08mean average precision\uff09  this way\uff08like tf.XX opreation\uff09</p>\n\n<p>How could I do\uff1f Thanks\uff01</p>\n", "acceptedAnswer": "<p>You can just calculate the y_score (or predictions) and then use sklearn.metrics to calculate the average precision:</p>\n<pre><code>from sklearn.metrics import average_precision_score\n\npredictions = model.predict(x_test)\naverage_precision_score(y_test, predictions)\n</code></pre>\n", "questionSource": "https://stackoverflow.com/questions/55261978/how-to-calculate-mean-average-precision-map-using-tensorflow"}